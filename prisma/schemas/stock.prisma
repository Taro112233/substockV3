// prisma/schemas/stock.prisma
// ===== 4. STOCK MANAGEMENT SCHEMA - ENHANCED V3.0 =====

// Stock with Department Isolation & Batch Tracking
model Stock {
  id            String     @id @default(cuid())
  drugId        String
  department    Department
  totalQuantity Int        @default(0) // ‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å batch
  reservedQty   Int        @default(0) // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡πÑ‡∏ß‡πâ
  minimumStock  Int        @default(10) // minimum stock ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏ô‡∏±‡πâ‡∏ô
  fixedStock    Int        @default(0) // minimum stock ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏ô‡∏±‡πâ‡∏ô
  totalValue    Float      @default(0) // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°
  lastUpdated   DateTime   @updatedAt

  // Relations
  drug         Drug               @relation(fields: [drugId], references: [id], onDelete: Cascade)
  transactions StockTransaction[]

  // Constraints - ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏¢‡∏≤‡πÉ‡∏ô 1 ‡πÅ‡∏ú‡∏ô‡∏Å‡∏°‡∏µ stock record ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  @@unique([drugId, department])
  // Indexes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Performance
  @@index([department])
  @@index([totalQuantity])
  @@index([drugId])
  @@map("stocks")
}

// ‚≠ê Enhanced Transaction Tracking with Minimum Stock Support
model StockTransaction {
  id         String  @id @default(cuid())
  stockId    String
  userId     String
  batchId    String? // Link to specific batch
  transferId String? // Link to transfer if applicable

  type      TransactionType
  
  // üì¶ STOCK QUANTITY FIELDS (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á)
  quantity  Int // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (+/-) ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å
  beforeQty Int // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  afterQty  Int // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£

  // üéØ MINIMUM STOCK FIELDS (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥) - ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
  minStockChange    Int? @default(0) // ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (+/-)
  beforeMinStock    Int? // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  afterMinStock     Int? // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£

  // üí∞ FINANCIAL FIELDS
  unitCost  Float @default(0)
  totalCost Float @default(0)

  // üìÑ REFERENCE & AUDIT FIELDS
  reference String? // ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
  note      String? // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
  createdAt DateTime @default(now())

  // Relations
  stock    Stock      @relation(fields: [stockId], references: [id], onDelete: Cascade)
  user     User       @relation(fields: [userId], references: [id])
  batch    DrugBatch? @relation(fields: [batchId], references: [id])
  transfer Transfer?  @relation(fields: [transferId], references: [id])

  // Indexes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Performance & Reporting
  @@index([stockId])
  @@index([type])
  @@index([transferId])
  @@index([createdAt])
  @@index([userId])
  @@map("stock_transactions")
}